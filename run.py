import sys
import paramiko
import os
from dotenv import load_dotenv
import re

def establishConnection(ssh_server, ssh_port, user, pasd):
    ssh_client = paramiko.client.SSHClient()
    ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

    try:
        ssh_client.connect(hostname=ssh_server, port=ssh_port, username=user, password=pasd)
    except paramiko.AuthenticationException:
        print("Authentication failed. Please check your username and password.")
        ssh_client.close()
        return None
    except paramiko.SSHException as e:
        print(f"SSH error: {e}")
        ssh_client.close()
        return None
    
    return ssh_client

def isCommandInstalled(base_cmd, ssh_client):
    stdin, stdout, stderr = ssh_client.exec_command(base_cmd)
    result = re.match(stderr.read().decode('utf-8'), 'command\ not\ found')
    return result

def runCommand(base_cmd, arguments):
    try:
        full_command = f"{base_cmd} {arguments}"
        stdin, stdout, stderr = ssh_client.exec_command(full_command)
        output = stdout.read().decode('utf-8')
        print(output)

    except paramiko.AuthenticationException:
        print("Authentication failed. Please check your username and password.")
    except paramiko.SSHException as e:
        print(f"SSH error: {e}")
    finally:
        ssh_client.close()

if __name__ == "__main__":
    if len(sys.argv) != 3 or sys.argv[1] == '-h':
        print("Usage: python3 script.py <base command> <arguments>")
        sys.exit(1)
    
    base_cmd = sys.argv[1]
    arguments = sys.argv[2]

    load_dotenv()

    server = os.environ.get("server")
    port = os.environ.get("port")
    username = os.environ.get("user")
    password = os.environ.get("password")

    ssh_client = establishConnection(ssh_server=server, ssh_port=port, user=username, pasd=password)

    if ssh_client != None:
        check = isCommandInstalled(base_cmd=base_cmd, ssh_client=ssh_client)
        
        if check != None:
            runCommand(base_cmd, arguments)
        else:
            print(f"{base_cmd} has not been installed on the server")
